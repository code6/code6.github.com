
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>MayCoder</title>
  <meta name="author" content="Code6">

  
  <meta name="description" content="2013-04-21
2013.7.26 update
知道什么呢，这件事情我直接拖了三个月，哦，这三个月我都干什么了，真该封我为拖延症冠军啊。 anyway, 还是继续写吧， move on。希望这次可以写完。
有一种观点我很赞同，就是要持续更新你的简历。
为什么要持续更新简历呢? &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://code6.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="MayCoder" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-29800624-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">MayCoder</a></h1>
  
    <h2>Valarmorghulis</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:code6.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/15/keep-updating-your-cv/">Keep Updating Your Cv</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-15T00:59:00+08:00" pubdate data-updated="true">Apr 15<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="date">2013-04-21</p>
<p>2013.7.26 update<br />
知道什么呢，这件事情我直接拖了三个月，哦，这三个月我都干什么了，真该封我为拖延症冠军啊。 anyway, 还是继续写吧， move on。希望这次可以写完。</p>
<p>有一种观点我很赞同，就是要持续更新你的简历。</p>
<h3>为什么要持续更新简历呢?</h3>
<p>首先做一件持续的事情很cool，有积累，有收获。<br />
维护一份简历可以让你看到工作概括，看到与牛人的差距( <a href="https://news.ycombinator.com/item?id=4472835">always benchmark against the best</a> )。<br />
维护一份简历可以让你在找下一份工作时不会手忙脚乱。<br />
&#8230;</p>
<p>在毕业之前我总共制作了中/英文两个简历, 其中中文是用 word 制作的，英文的话是用学长留下来的 latex 模板制作的。在找完工作后我基本没有维护过简历了。作为一个希望能够持续总结的人，面对着停留在两年前毕业的简历，感觉是不能忍了。 我们不仅要认同一种观点，还要亲身去实践才算, 于是我开始实践更新简历这件事情(从写下这句话的三个月后，god)。</p>
<h3>如何更好/方便地维护简历呢?</h3>
<p>要做到定期维护简历的话，每次更新简历的代价就不能太高。良好的简历维护应该能够做到:<br />
关注内容而不用在意展示<br />
最好是文本编辑，方便版本控制和追溯</p>
<p>latex 版的简历看起来赏心悦目, 不过制作起来稍显复杂, 也不容易维护(latex菜鸟意见= =)。word 就更不用说了，排版不是很容易，也很难做版本控制。<br />
考虑维护简历这是一个长期的过程，我希望更新/生成简历能尽可能快且保持高质量。<br />
于是我考虑是否能用 markdown 来写简历呢。  确实发现很多文章介绍用 markdown 来写简历。</p>
<h4>使用 markdown 来制作简历</h4>
<p>鉴于有使用 markdown 的习惯，于是很自然地考虑到使用 markdown 来写简历，最开始在 github 上看到 <a href="https://github.com/mwhite/resume">mwhite的resume</a>  项目看起来还不错。这里使用到一个好东西，叫 pandoc，可以在不同文件格式之间转换。比如只写了markdown 版本，可以转换成 html/latex, 看起来挺方便的。不过原仓库的排版不太喜欢，改起来又似乎有点麻烦。 同样还有一个 icco的 <a href="https://github.com/icco/Resume">Resume</a> 也是同理，写 markdown 然后 host 到 github 上之类的, 相比之前其排版会相对美观一点。<br />
编写 markdown 可以直接在 vim 中敲敲打打，也可以是用  <a href="http://mouapp.com/">Mou</a> ，一款十分好用的 markdown 编辑器。</p>
<h4>markdown 有什么问题呢?</h4>
<p>我遇到的问题是难以把漂亮的 markdown 转化成 漂亮的 pdf，直接从 markdown 转换成 pdf 会出现各种边距问题。在努力尝试一番未果时，后面我退回到 latex 了= = 不仅做 markdown 还做 latex, 然后 pdf 版本简历还是用 latex 出吧。mac 上我安装了 <a href="http://tug.org/mactex/downloading.html">mactex</a> 来编写 latex, 基本的节奏还是在找比较好的模板，然后填上自己的内容。</p>
<h3>如何编写你的简历?</h3>
<p>当工具本身的选择搞定，剩下的就是内容和排版了。<br />
在内容方面， <a href="http://dreamrunner.org/wiki/public_html/Books%20Review/%20Interview/The%20Google%20Resume.html#sec-3">google reusme</a> 第四章中给出蛮多中肯的建议。<br />
工作经历是简历中一个重要组成部分，在介绍过往工作时, 要注意以下几点:<br />
<code>成就导向</code><br />
主要以你完成了什么而不是介绍你在做什么，这里即突出你的贡献而不是你的职责, 而且应着重突出重要贡献(bullet)。<br />
<code>量化结果</code><br />
量化你的贡献，用数据说话。</p>
<p>至于排版方面, 有几个建议:<br />
<code>干净, 专业，一致</code><br />
体现在统一间距和对齐上，简单来说就是要看着漂亮，顺眼。<br />
<code>控制在一页简历</code><br />
简历控制在一页纸上方便阅读，太长后面部分基本也没有pv。只放最相关的重要部分。<br />
<code>突出亮点主题</code><br />
理论上越有亮点的部分放越前面效果越好，但考虑到主题前后条理性还需要做一些适应性调整。一个明显的例子是如果教育经历不是很出彩，可以考虑将其往后挪。</p>
<p>当然以上几点我也基本没完成，只是比较赞同。</p>
<h3>我的成果</h3>
<p>初步做了 <a href="https://github.com/code6/playground/blob/master/resume/cv_md/code6_en.md">markdown版本</a> 和 <a href="https://github.com/code6/playground/blob/master/resume/cv_latex/v2/code6_v2.pdf">latex版本的简历</a> , 目前 <code>Experience</code> 展开略细，还需进一步改进。 简单观察，很容易就发现目前我简历的问题:<br />
工作没有亮点, 参与而不是推动<br />
技术能力没有杀手锏<br />
没有个人项目</p>
<p>没有做得很漂亮，发现问题就想办法去改进吧:)</p>
<p>ps:<br />
又是一件拖延了很久的事情，大概是从今年二月份开始就想做了，每天对自己念一遍我要把这件事情搞定，于是可以搞定，感谢sean。</p>
<p>Ref:<br />
<a href="http://bitlyfied.com/2013/03/14/markdown-cv/">markdown-cv</a><br />
<a href="http://cmwelsh.com/beautiful-resumes-with-markdown-and-latex">beautiful-resumes-with-markdown-and-latex</a><br />
<a href="http://dreamrunner.org/wiki/public_html/Books%20Review/%20Interview/The%20Google%20Resume.html#sec-3">google reusme</a><br />
<a href="http://shenfeng.me/resume/index.html">shenfeng&#8217;s cv</a><br />
<a href="http://mijia.org/cv">mijia&#8217;s cv</a><br />
<a href="http://blog.devep.net/virushuo/2005/06/06/1118072629843.html">如何做简历</a></p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/04/query-evolution/">Query Evolution</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-04T11:52:00+08:00" pubdate data-updated="true">Apr 4<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="date">2013-04-04</p>
<p>从最原始的查询开始，位于后台某个报表，当用户发起一个查询，我们该干啥呢?</p>
<p>抽象一种最简单的形式，查询是对我们的数据做一定的转换而得来的，即</p>
<p><img src="/images/query_evolution_pic/all_data_function_query.jpeg"></p>
<p>按这样的理解，当用户发起一个查询时，我们可以直接在原始数据集上进行操作, 操作的过程可以在服务端或者客户端。</p>
<p><img src="/images/query_evolution_pic/all_data_function_query_2.jpeg"></p>
<p>直接在原始数据上操作查询数据是非常艰难的，业务方面的数据并不是那么查询友好，有多个查询需求时得重复很多重复的代码和计算。</p>
<p>于是我们很容易想到上述的模型需要再添加一层预处理层，方便查询。</p>
<p><img src="/images/query_evolution_pic/add_precompute_view.jpeg"></p>
<p>在实际处理当中，我们本着依靠数据仓库理论武装自己的原则，对原始数据做了系统的预处理后形成了一个数据仓库。</p>
<p><img src="/images/query_evolution_pic/precompute_in_dw.jpeg"></p>
<p>由于引入了预计算，就有了一个数据更新问题。为了抠那一点时间和空间，我们绞尽脑汁想到了一种所谓增量更新( incremental update)的方法，于是数据愉快地更新起来了。</p>
<p>机器或者人工的失误，数据源数据发生了错误或遗失，对于我们的预处理层真是一次灾难啊，没什么好说的，只能重算了。</p>
<p><img src="/images/query_evolution_pic/incremental_update_failed.jpeg"></p>
<p>由于数据规模逐渐增加，单机的关系数据库渐渐扛不住了，我们只能引入分布式的处理(mapred)来分担预处理的压力。</p>
<p><img src="/images/query_evolution_pic/switch_to_hadoop.jpeg"></p>
<p>在分布式计算模式下，原有的关系数据库特性已经不在那么好用了。索引剪枝不再好使，增量更新也不易于实现，于是大部分情况下，我们粗暴地全量计算，我们再也不怕历史数据有问题了。</p>
<p>随着预处理数据渐渐地迁移，不可避免地我们需要查询分布式数据库(hive), 这样我们的查询必须支持那种异构的数据源了，我们可以再加上一层，把各类查询都接入。</p>
<p><img src="/images/query_evolution_pic/add_query_service.jpeg"></p>
<p>我们称这个新的服务是查询中心，它将作为一切查询的入口，也体现了一种服务化的理念。</p>
<p>当然，各类的查询区别明显，普通报表query 和 api 一般执行快，要求响应也快。对于用户发起adhoc 操作，则可能查询费时也不一定需要及时响应。对于这样一个包容性的服务来说是个考验。</p>
<p>似乎漏了几部分？</p>
<ul>
	<li>由于有了预处理，查询数据的实时性不可避免要打折。</li>
	<li>对于分布式数据库数据访问有点过慢(目前的策略是将聚合结果写回关系型数据库来支持快速查询)。</li>
	<li>数据应用方面，推荐/搜索相关的线上查询服务设计
	<ul>
		<li>感觉支持后台数据服务和线上服务还是不能混在一块的</li>
	</ul></li>
</ul>
<p>这些都是可改进的点，围绕着查询这个主题。</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/09/create-a-python-package/">Create a Python Package</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-09T00:35:00+08:00" pubdate data-updated="true">Jan 9<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在简单做了一个类 <code>hiveserver</code> 的thrift 接口后，担心日后接口更新，我又添加了一个简单的python client包(没有照顾其他用户= =)。作为要分发给用户使用的包，我需要将其打包发布, 然后才好分发。</p>
<p>参考 <a href="http://guide.python-distribute.org/index.html">The Hitchhiker’s Guide to Packaging</a> 文档简单了操作了一下，倒也不麻烦。</p>
<p>目录结构:<br />
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>package tree  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>.
</span><span class='line'>├── CHANGE.txt
</span><span class='line'>├── LICENSE.txt
</span><span class='line'>├── OpenHiveClient
</span><span class='line'>│   ├── client.py
</span><span class='line'>│   ├── __init__.py
</span><span class='line'>│   ├── openhive_thrift
</span><span class='line'>│   │   ├── __init__.py
</span><span class='line'>│   │   └── openhive
</span><span class='line'>│   │   ├── constants.py
</span><span class='line'>│   │   ├── __init__.py
</span><span class='line'>│   │   ├── OpenHive.py
</span><span class='line'>│   │   ├── OpenHive-remote
</span><span class='line'>│   │   ├── ttypes.py
</span><span class='line'>│   └── openhive.thrift
</span><span class='line'>├── README.txt
</span><span class='line'>└── setup.py
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>其中 <code>OpenHiveClient</code> 即为要发布的package, 其中的子目录 <code>openhive_thrift</code> 为 thrift 生成的文件。</p>
<p>setup文件内容如下:</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>setup.py  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span>
</span><span class='line'><span class="n">setup</span><span class="p">(</span>
</span><span class='line'><span class="n">name</span><span class="o">=</span><span class="s">&#39;OpenHiveClient&#39;</span><span class="p">,</span>
</span><span class='line'><span class="n">version</span><span class="o">=</span><span class="s">&#39;0.1.0&#39;</span><span class="p">,</span>
</span><span class='line'><span class="n">author</span><span class="o">=</span><span class="s">&#39;code6&#39;</span><span class="p">,</span>
</span><span class='line'><span class="n">author_email</span><span class="o">=</span><span class="s">&#39;wuzhichun@meituan.com&#39;</span><span class="p">,</span>
</span><span class='line'><span class="n">packages</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;OpenHiveClient&#39;</span><span class="p">,</span> <span class="s">&#39;OpenHiveClient/openhive_thrift&#39;</span><span class="p">,</span> <span class="s">&#39;OpenHiveClient/openhive_thrift/openhive&#39;</span><span class="p">],</span>
</span><span class='line'><span class="n">license</span><span class="o">=</span><span class="s">&#39;LICENSE.txt&#39;</span><span class="p">,</span>
</span><span class='line'><span class="n">description</span><span class="o">=</span><span class="s">&#39;open hive query client&#39;</span><span class="p">,</span>
</span><span class='line'><span class="n">long_description</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;README.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>部分meta填写较随意，无影响。使用 <code>distutils</code>, packages一项似乎得写出所有的包，有点繁琐, 使用的是 <code>setuptools</code> , 有自带一个 <a href="http://packages.python.org/distribute/setuptools.html#using-find-packages">find_package</a> 的方法，那样写比较方便~~~</p>
<p>如果要打包的是单文件的话可以使用 <a href="http://docs.python.org/2/distutils/setupscript.html#listing-individual-modules">py_module</a> 参数。</p>
<p>后续执行 <code>python setup sdist</code> 可生成发行包 <code>OpenHiveClient-0.1.0.tar.gz</code> , 可直接使用 <code>pip install OpenHiveClient-0.1.0.tar.gz</code> 安装,  如果需要更新安装包但没有改版本号的话可以使用 <code>-U</code> 强制刷新。</p>
<p>目前敝厂没有私有pypi服务器，所以为了一个包搞一个的话没必要，一种方式是可以挂在公开的地方比如github之类的。 挂在 pypi 上的问题是不能上传覆盖相同版本号的安装包。这也很合理，应该是开发到一定程度才发布稳定版才对，跟我们在代码仓库上一修改就发布的节奏是不太一样的。</p>
<p>当然，上文都是指要做一个分发的包，如果是部署自身线上服务使用的包，完全可以直接放到代码仓库中同步到线上然后直接安装。</p>
<p>打成包的好处是将独立于业务的模块抽出来后方面引用，可以避免加上一堆 <code>sys.path.append</code> 了, 当然维护成本稍有上升。</p>
<h3><strong>附录</strong></h3>
<p>http://guide.python-distribute.org/creation.html<br />
http://woodpecker.org.cn/diveintopython3/packaging.html<br />
http://www.worldhello.net/2011/03/14/2357.html<br />
http://www.ibm.com/developerworks/cn/opensource/os-pythonpackaging/index.html</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/12/02/open-hive/">Open Hive</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-02T21:48:00+08:00" pubdate data-updated="true">Dec 2<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="date">2013-01-05</p>
<p>有时我说的话就是放屁，这已经都到 <del>12月</del> 1月了。不过我还是厚着脸皮来了，我还是希望写写的，每当我来refer自己干过的一些事情的时候, 还蛮有用的。</p>
<p>今天我想说的是近期我们在做的一个事情，说来也简单，往往我觉得难的不是要写多高深的代码，而是采取什么方式来达到一个目的, 满足需求。我的条理还有待加强，暂且这样。</p>
<p>对于做数据的团队，一个很重要的事情就是开放数据，怎样提供一个更好的环境来让更多的人来访问数据，获取他们关心的内容。如果数据始终是仅在团队内部可以使用，那么势必会增加很多重复的无谓的体力劳动。在开放数据这一块，之前大家做了一些努力，有了一个内部的自助查询的系统，面向RD和一般的分析人员。开放的方式是提供一个窗口让用户写具体的SQL来查询，返回查询结果, 并可以定制很多图表。 系统内开放了若干链接，每个链接可以查若干表，并可以看到表相关的字段信息。一般来说这样就够了，当然写SQL门槛稍稍有点高。</p>
<p>之前主要数据都是在 mysql 上，开放的方式也非常简单, 只需要提供一个从库即可, 让查询都落在从库上，然后主库进行更新。当我们在mysql撑不住，逐步迁移到hive的同时，自助查询这边相应的也需要改进以支持hive查询。虽然已经有包括 hwi( <a href="https://github.com/anjuke/hwi">anjuke的改进版hwi</a> ) 和 phphiveadmin 以及 hue(我们用apache hadoop, 用不了cloudera的产品)了，感觉跟我们自己的查询工具结合在一起会比较方便使用。结合的方式也比较简单, 简单使用hive cli的执行方式来查询并保存结果数据即可, 大致如下:</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>run hive query  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>hive -f /tmp/testsql 1&gt;testsql.output 2&gt;testsql.err
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>这样把查询结果放在临时文件中，然后再展示给用户。另外由于hive查询一般比较久，故只能做成异步查询。</p>
<p>这里为什么不用hiveserver呢? 感觉hiveserver在我们这边使用总有一些问题，使用hive 0.9 配合zookeeper时，hiveserver看起来会泄露zookeeper连接，导致一段时间后就不可用了。 当然也可能是我们的姿势不对, 不知在 hive 0.10 上是否会好些。</p>
<p>开放查询做到这一步其实基本差不多了, 用户可以自己执行查询并查看/下载结果集。 但我们在这一步的时候却还不能开放，觉得对用户的控制还不够，用户权限太大了。 说到这一点，我们目前的hadoop/hive环境上只有一个默认用户，其余用于查询的用户(比如apache)基本上对所有表都有查询权限。另外一点是我们线上的hive任务也在定期执行，自助查询这边不应该占用过多资源。在一些必要场合下我们必须有能力干掉用户的查询。简单来说，初步开放，我们需要做到:<br />
<strong>必要的权限控制</strong><br />
库/表级别，语句类型(限制只能使用select)，这些控制可以跟账号绑定。<br />
<strong>资源限制</strong><br />
任务同时可以起的map数量和reduce数量控制。<br />
<strong>锁限制</strong><br />
自助查询不能争用线上任务的锁。</p>
<ul>
	<li><strong>必要的权限控制</strong><br />
在做权限控制的时候本来想直接用 <code>hive.security.authorization.enabled</code> 参数来搞，发现当所有用户都拿一个账号(apache)来访问是没啥用的= =, 没办法，只能手动搞了，于是比较糙地搞了个类似的自己用, 表如下:</li>
</ul>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>hivetablepriv   </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">REATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">hivetablepriv</span><span class="o">`</span> <span class="p">(</span>
</span><span class='line'>  <span class="o">`</span><span class="n">grantid</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">COMMENT</span> <span class="s1">&#39;授权自增ID&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">rolename</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span> <span class="k">COMMENT</span> <span class="s1">&#39;授权角色名&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">dbname</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span> <span class="k">COMMENT</span> <span class="s1">&#39;授权库名&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">tablename</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span> <span class="k">COMMENT</span> <span class="s1">&#39;授权表名, *表示任意表&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">modtime</span><span class="o">`</span> <span class="n">datetime</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0000-00-00 00:00:00&#39;</span> <span class="k">COMMENT</span> <span class="s1">&#39;记录修改时间&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">status</span><span class="o">`</span> <span class="n">tinyint</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="n">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span> <span class="k">COMMENT</span> <span class="s1">&#39;0为正常授权，128为已删除授权&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">grantid</span><span class="o">`</span><span class="p">),</span>
</span><span class='line'>  <span class="k">UNIQUE</span> <span class="k">KEY</span> <span class="o">`</span><span class="n">rolename</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">rolename</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">dbname</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">tablename</span><span class="o">`</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">62</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span> <span class="k">COMMENT</span><span class="o">=</span><span class="s1">&#39;hive开放查询权限表&#39;</span>
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>然后在实际查询的时候，使用虚拟角色来访问，解析一下查询语句使用到的表(简单正则)，然后进行一下权限判断即可。</p>
<ul>
	<li><strong>资源限制</strong><br />
这步可以很简单做，比如直接在 <code>Hadoop Fair Scheduler</code> 配置一个受限的队列即可, 基本可以保证资源限制。</li>
</ul>
<ul>
	<li><strong>锁限制</strong><br />
我们打开了 <code>hive.support.concurrency</code> 并使用zookeeper来进行锁竞争，主要是防止线上日常ETL程序执行过程中对资源有竞争(比如一个表在更新时有流程访问)，这里在自己查询避免争用线上任务的锁只需要关闭此开关即可。</li>
</ul>
<p>综上, 我们仅需把执行语句加强一下:</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>run hive query safely  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>hive --hiveconf hive.support.concurrency<span class="o">=</span><span class="nb">false</span> -hiveconf mapred.queue.name<span class="o">=</span>slow -f /tmp/testsql 1&gt;testsql.output 2&gt;testsql.err
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>另外权限控制我们在查询脚本执行查询之前做。我们还缺的一件事情是记录下用户的查询(logging)。这一步也可以简单在hive执行脚本中收集。为了能够更好的监控这些任务，我们还需要能够将查询和其所起的任务关联起来。这里使用了一个比较土的方法，就是边执行边解析程序的标准错误, 收集日志中提到的起的hadoop jobid。有了这些信息之后，就可以将一个查询所对应的任务干掉了。</p>
<p>这样我们只靠一个简单查询脚本就可以基本的给hive查询一个具有较好约束的执行环境了。这个openhive脚本可以直接给自助查询工具查询hive使用。不过对于其他RD有需求查询hive数据的，我们还得暴露一个较友好的接口，比如使用 <code>thrift</code> 做一个服务。想到这边我又想到 <code>hiveserver</code> 了, 感觉我的想法有点多余。不过还是那个问题，我们希望有更多控制，然后又不太想在hive源码上动手脚(觉得麻烦以及以后升级比较有问题, 当然主要是我对java不熟)，所以搭 <code>thrift</code> 然后背后用调用 openhive 脚本来实现, 接口可以这样:</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>openhive.thrift   </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">Query</span> <span class="p">{</span>
</span><span class='line'>  <span class="mi">1</span><span class="o">:</span> <span class="n">required</span> <span class="n">string</span> <span class="n">query</span><span class="p">,</span>
</span><span class='line'>  <span class="mi">2</span><span class="o">:</span> <span class="n">required</span> <span class="n">string</span> <span class="n">username</span><span class="p">,</span>
</span><span class='line'>  <span class="mi">3</span><span class="o">:</span> <span class="n">optional</span> <span class="n">string</span> <span class="n">password</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">exception</span> <span class="n">OpenHiveException</span> <span class="p">{</span>
</span><span class='line'>  <span class="mi">1</span><span class="o">:</span> <span class="n">string</span> <span class="n">message</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">service</span> <span class="n">OpenHive</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="cp"># Execute a query. Takes a HiveQL string</span>
</span><span class='line'>  <span class="kt">void</span> <span class="n">query</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="n">Query</span> <span class="n">q</span><span class="p">)</span> <span class="n">throws</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="n">OpenHiveException</span> <span class="n">ex</span><span class="p">)</span>
</span><span class='line'>  <span class="cp"># Fetch one row. This row is the serialized form</span>
</span><span class='line'>  <span class="cp"># of the result of the query</span>
</span><span class='line'>  <span class="n">string</span> <span class="n">fetchOne</span><span class="p">()</span> <span class="n">throws</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="n">OpenHiveException</span> <span class="n">ex</span><span class="p">)</span>
</span><span class='line'>  <span class="cp"># Fetch a given number of rows or remaining number of</span>
</span><span class='line'>  <span class="cp"># rows whichever is smaller.</span>
</span><span class='line'>  <span class="n">list</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">fetchN</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="n">i32</span> <span class="n">numRows</span><span class="p">)</span> <span class="n">throws</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="n">OpenHiveException</span> <span class="n">ex</span><span class="p">)</span>
</span><span class='line'>  <span class="cp"># Fetch all rows of the query result</span>
</span><span class='line'>  <span class="n">list</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">fetchAll</span><span class="p">()</span> <span class="n">throws</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="n">OpenHiveException</span> <span class="n">ex</span><span class="p">)</span>
</span><span class='line'>  <span class="cp"># Fetch Query header</span>
</span><span class='line'>  <span class="n">string</span> <span class="n">fetchQueryHeader</span><span class="p">()</span> <span class="n">throws</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="n">OpenHiveException</span> <span class="n">ex</span><span class="p">)</span>
</span><span class='line'>  <span class="cp"># Fetch all query log</span>
</span><span class='line'>  <span class="n">string</span> <span class="n">fetchQueryLog</span><span class="p">()</span> <span class="n">throws</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="n">OpenHiveException</span> <span class="n">ex</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>整个接口基本是 <code>hiveserver</code> 的子集= = 服务端简单使用Python来搞，使用thrift的 <code>ProcessPoolServer</code> 类 ，其原理是server启动时fork出N个工作进程，进程之间不影响且可以重复使用。 这样遇到的问题是服务器的处理有瓶颈，每次最多同时处理N个任务，来多了会阻塞，目前我暂时将N设置为10。后续完全可以做成异步的形式，当然得修改接口，比如添加一个 <code>sessionid</code>  的概念。后来跟同事商量，其实对于hive查询本身server端是没有什么压力的(主要在hadoop集群上), 故基本不需要考虑 <code>python GIL</code> 问题而使用多进程。另外他建议使用 <code>gevent</code> 来提高server的并发能力，当然这样瓶颈就落到后端查询上了，感觉还是需要一个队列的机制，倒是可以试试。</p>
<p>大概就是这样了，废话了很多其实内容很少，也很简单。条理和叙述方式有待加强，终于又写了一篇blog，欢迎交流反馈~~</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/19/hive-compile-and-apply-patch/">Hive Compile and Apply Patch</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-19T13:38:00+08:00" pubdate data-updated="true">Sep 19<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="date">2012-09-20</p>
<p>回归来的第一篇，另外还有好几篇躺在 <code>published:false</code> 中，还没搞好 :-(</p>
<p>这个礼拜最大的收获是编译啥啥啥还是蛮简单的，又没叫你去改代码。有些东西动手尝试一下，往往会发现没有多难，不能停留在口上上说说而已。看到 <a href="http://blog.liancheng.info/wq-2008-1/">一段相关但不是很切题的话</a> :</p>
<blockquote>
<p>不可忽视的一点是：在技术性团体里，做永远比说要来的有效。在想法成熟之前就贸然游说，往往会招致相反的效果。大家都是工程师，不会贸然接纳陌生事物。如果自己都还没有想清楚就开始大肆游说，往往会被大家提出的实际的工程问题驳斥地体无完肤。当你哑口无言之时，大家也已经对你的方案产生了难以磨灭的 “不靠谱”的第一印象，这时要再想咸鱼翻身，可就没那么容易了。</p>
</blockquote>
<blockquote>
<p>相对的，首先自行查阅文档资料并进行试验，制作demo，通过试验发现和解决实际出现的问题。在想法基本成型时，和个别观念开放的同仁进行探讨，这时往往可以发现大量之前自己没有考虑到的问题，再转而细化方案。这个过程反复迭代几次之后，方案和demo逐渐成熟，同时也潜移默化地达到了传教的目的。等到方案完全成熟之后，再拿出实际可工作的demo开始游说，这时自然就成竹在胸了。</p>
</blockquote>
<p>进入正题，这里主要是参考几篇文章，说说编译hive和打补丁, 或者说贴贴链接= =</p>
<h3>hive 代码编译</h3>
<p><a href="http://railsbuilder.blogspot.com/2010/06/installing-hive-on-linux.html">install hive on linux</a>  <br />
<a href="http://blog.csdn.net/scutshuxue/article/details/5915689">使用ant编译hive</a>  <br />
<a href="http://blog.csdn.net/cfy_yinwenhao/article/details/6977882">hive打补丁编译hive</a></p>
<p>这里我在ubuntu上操作的, 编译hive需要依赖 <span class="caps">JAVA</span>, <span class="caps">ANT</span> (这里不依赖hadoop原因是ant会自动去下载hadoop)。 <br />
安装好后export <code>JAVA_HOME</code> , <code>ANT_HOME</code> 变量 (我直接加入.bashrc当中了)。<br />
接下来去官网下载hive源码包。这里我使用的是 <code>hive.0.9.0</code> 。 解压之后进入src目录，需要修改一些配置:</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>build&#46;properties </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>hadoop.version=1.0.1
</span><span class='line'>
</span><span class='line'>主要是facebook被墙了，镜像地址可参考 http://www.apache.org/dyn/closer.cgi/hadoop/core/
</span><span class='line'>hadoop.mirror1=http://mirror.bjtu.edu.cn/apache  
</span><span class='line'>hadoop.mirror2=http://mirror.bjtu.edu.cn/apache
</span><span class='line'>
</span><span class='line'>以下的修改主要是看到镜像中的hadoop版本已经没有默认的版本号了，估计是不支持了?故改成包含的版本号。
</span><span class='line'>hadoop-0.20.version=0.20.2
</span><span class='line'>hadoop-0.20S.version=1.0.1 (S的版本不知有没有啥区别)</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>接下来执行 <code>ant package</code> 即开始编译了, 结果默认会放在 <code>build/dist</code> 目录中，使用 <code>-Dtarget.dir=xxx</code> 可以更新目标位置。</p>
<p>如果BUILD FAIL的话，一般参考提示可以看出是哪里出了问题(遇到比较多还是被墙的问题= =)。</p>
<h3>hive 单元测试</h3>
<p><a href="http://www.oratea.net/?p=632">hive中的单元测试</a><br />
<a href="http://blog.csdn.net/bupt041137/article/details/6553770">hive中的test case</a><br />
<a href="http://blog.csdn.net/bupt041137/article/details/6553760">QtestUtil.java</a><br />
<a href="http://blog.csdn.net/bupt041137/article/details/6553760">hive unit test</a></p>
<p>hive 中的 <a href="https://cwiki.apache.org/Hive/howtocontribute.html#HowToContribute-UnitTests">单元测试</a> 还是蛮有趣的，既有传统的单元测试代码，又可以批量执行查询脚本判断结果是否一致:</p>
<blockquote>
<p>在hive中会有大量的.q的文件即执行测试的query文件，.q.out是测试的结果文件。 进行新测试后产生的结果和标准的q.out一致则表示测试成功。<br />
具体来说，src/ql/src/test/queries下面是测试用例，clientpositive是运行成功的用例，clientnegative是运行失败，返回非0的用例。 src/ql/src/test/results 下面是测试用例对应的输出结果。 如src/ql/src/test/queries/case_sensitivity.q对应的输出结果是src/ql/src/test/results/case_sensitivity.q.out 。</p>
</blockquote>
<p>使用 <code>ant test</code> 运行单元测试，不过此命令要跑好多测试， <a href="https://builds.apache.org/job/Hive-trunk-h0.21/1671/testReport/org.apache.hadoop.hive.cli/TestCliDriver/">光TestCliDriver一项就要跑好几个小时</a> , 我们可以</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>ant test </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>运行所有的正面的测试
</span><span class='line'>ant test -Dtestcase=TestCliDriver
</span><span class='line'> 
</span><span class='line'>运行特定的测试，以groupby为例子
</span><span class='line'>ant test -Dtestcase=TestCliDriver -Dqfile=groupby1.q</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>使用 <code>-Doverwrite=true</code> 可以覆盖结果文件，后面有新的更新想测试表现是否一致的时候就可以使用了, 通常在我们增加新的udf的时候可以这么来生成测试数据。</p>
<h3>hive代码打补丁</h3>
<p>下载了 <code>hive 0.9.0</code> 稳定版，不过发布之后还是有若干bug，这时搜索一下 <code>hive jira</code> 一般能看到相应ticket，比如 <a href="https://issues.apache.org/jira/browse/HIVE-2942">这个substr遇到UTF8的问题</a> 。一般打的补丁会走一个 <code>publish-review-apply</code> 的 <a href="http://www.google.com.hk/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=4&amp;cad=rja&amp;ved=0CEIQFjAD&amp;url=http%3A%2F%2Fwww.cs.pdx.edu%2F~bart%2Fpapers%2Fpicmet-patch.pdf&amp;ei=g0VbUK6LDITqmAW2tICQCQ&amp;usg=AFQjCNEoh5FKA_8KNBa5-Pr-gMaQPHS9GA&amp;sig2=ISd1WAautuWBKKfc_Vv3lg">过程</a> ，准确解决问题的补丁会被加入版本库中，而临时补丁一般不会采用。作为用户，有时难免得打一些这样的补丁。打补丁也很方便，下载社区提供的补丁之后，使用 <code>patch</code> 命令即可以应用到源码中, 后续在进行编译测试即可。</p>
<p>另外我们有时会有需求将 <a href="http://my.oschina.net/wangjiankui/blog/64230">自己使用的 udf 编译到hive当中以方便使用</a> ，这其实也可以看成打补丁的行为。</p>
<p>打补丁多了，管理是后面会遇到的问题。 就个人而言，可以自己载个官方的git仓库，然后开分支来维护自己的变更。如果要多人协作的话，可以创建一个新的git仓库，然后添加两个远端, 其中一个是官方的git仓库，另外一个可以是大家从某个分支开始维护的版本。纯属yy，实际操作起来也未必省心。 这里看起来使用 <a href="https://github.com/blog/674-introducing-organizations">github organization</a> 是蛮适合的。</p>
<p>当然，可以预见的是，大部分时间我们都不会打补丁，可能只会在新增一些UDF= =, 于是似乎完全没有必要这么干, 大概 <a href="https://github.com/nexr/hive-udf">类似这样就可以了</a> , 看起来一般将用到的udf打包，然后要用的时候加一句声明即可。</p>
<p>不过我还是蛋疼去搞了一个 <a href="https://github.com/MTDATA/hive">organization</a> , fork一下官方代码。 我在本地git加入 <code>apache/hive</code> 作为另一个远端, 称为 <code>mirror</code> 。由于我们目前使用的是 0.9, 故我考虑的是在 <code>origin/branch-0.9</code> 下做开发，并将 <code>mirror/branch-0.9</code> 定期 merge 回 <code>branch-0.9</code> 。至于 <code>trunk</code> 则不动。</p>
<p>这样一来我就开始捣鼓了，首先还是改 <code>build.properties</code> , 我将这些也一并提交到分支里面了。 然后我开始将 udf 编译进去，这次遇到一个比较坑爹的问题就是 <strong>编译一直成功，但是执行单元测试一直找不到新的UDF</strong> 。 捣鼓了很久无果后找小美支援，小美在分析一阵之指出测试的时候没有引用到编译的 <code>FunctionRegistry.class</code> , 估计使用到别的旧的文件了。又过了一段时间之后我确实发现有个地方 <code>~/.ivy2/</code> 下面有一些cache, 简单google之后又发现 <code>hive jira</code> 上已经有一个 <a href="https://issues.apache.org/jira/browse/HIVE-3092">tck</a> , 看了大概是由 <a href="https://issues.apache.org/jira/browse/HIVE-2646"><span class="caps">HIVE</span>-2646</a> 引入的, 导致测试的时候会从ivy cache来加载hive相关的类而不是 <code>build/dist/lib</code> 。这个改动恰恰不在 0.9.0发布版但是 commit到 <code>branch-0.9</code> 中了, 所以我从 <code>branch-0.9</code> 的代码开始编译就中招了。这个patch有加入trunk中，故 <code>cherry-pick</code> 一下即可(本来我打算直接打patch的)。当然这里我不清楚为啥这个补丁不加入 0.9 分支，估计不算大问题? 没有运行bug？从版本库编译就是比较坑爹= =</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/19/learning-algo-part-i-at-coursera-dot-org/">Learning Algo Part I at coursera.org</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-19T01:55:00+08:00" pubdate data-updated="true">Sep 19<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>用来记录我在 coursera.org 上学习  Algo Part I的记录，写完之后发布。</p>
<p>看起来要来不及了。。。要不然就看PPT恶补吧，dealline(9月30号)快到了。</p>
<p>2012.12.16<br />
以上已经完全来不及= = 我的第一门coursera课就这样悲剧了。<br />
另外后续我跟小美同学一起开始学 compiler 这门课，还是没有分出足够的时间来做相应的学习，不过小美同学就很有效率地完成了大部分作业。<br />
近期我的 <a href="https://www.coursera.org/course/algo2">第三门课</a> 已经开课两个星期了，我感觉必须搞定这种被时间追赶着的状态。<br />
之前一直困扰我的是网络太差，看视频太麻烦，于是google 一个能下载视频的脚本，果然 <a href="https://github.com/jplehmann/coursera">很容易在github上找到了</a> 。<br />
代码写的还蛮简单漂亮的，后续下载视频只需要一句话:</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>coursera video download </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/Users/code6/git/coursera/coursera-dl -n --path  "/Users/code6/Downloads/coursera/videos/algo2/"  -w /usr/local/bin/wget algo2-2012-001</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>如果一个东西很难获得，势必增加做某件事情的阻力，但如果太容易获得，也是如此，在下载视频这件事来看也是如此。</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/13/back-for-blogging-more/">Back for Blogging More</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-13T04:31:00+08:00" pubdate data-updated="true">Sep 13<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="date">2012-09-13</p>
<p>感到很失败，未能完成之前所说的一周发表一篇blog的计划。<br />
但我还是有很多想说的，感觉如果在工作中不能记录下只言片语的话，那到头来就没有什么留下了了，所谓经验其实远不如总结沉淀来得安稳。<br />
但我是不是没有干活呢，只能说是懒惰，不想多费些时间心力来记录生活，学习。<br />
那今天是什么一个情况呢，组里面吃饭的时候在讨论一些问题，聊到了执行力，能力。想想我在blogging上的动作，实在羞愧。<br />
其实有很多方面可以记录，无论是失败还是成功，我常常想所谓的不成熟其实是最大的阻碍，就像wiki一样，先有了，然后可以慢慢更新的，犯不着要一下子就掌握的非常好。<br />
所以，仅以此blog作为契机，让我再次开始记录生活，记录工作。<br />
blog是另外一种认识自己的方式，可以更深刻，更有味道。</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/03/programming-contest-fun-in-the-first-weekend-of-june/">6月第一周比赛小计</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-03T09:41:00+08:00" pubdate data-updated="true">Jun 3<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="date">2012-06-04</p>
<p>6月第一个周末比赛好多啊，做了其中的4个，很爽:</p>
<table>
	<tr style="background:#ddd;">
		<td style="width:200px;">比赛 </td>
		<td style="width:200px;">开始时间 </td>
	</tr>
	<tr>
		<td> Astar 2012 R1a  </td>
		<td> 2012.6.2 10:00 </td>
	</tr>
	<tr>
		<td> <a href="http://ipsc.ksp.sk/contests/ipsc2012/results/">ipsc 2012</a>  </td>
		<td> 2012.6.2 18:0 0</td>
	</tr>
	<tr>
		<td> <span class="caps">TCO</span> 2012 R2c  </td>
		<td> 2012.6.3 00:00 </td>
	</tr>
	<tr>
		<td> Astar 2012 R1b  </td>
		<td>2012.6.3 10:00</td>
	</tr>
</table>
<p></p>
<p>结果不是很重要，关键是又稍微思考了下, 但这样没有规律的思考是无法提高的，倒是也得想办法弄一个周期性较强的训练时间, 挨个稍微说一下吧。</p>
<ul>
	<li><strong>Astar 2012 R1a</strong></li>
</ul>
<table>
	<tr style="background:#ddd;">
		<td style="width:100px;">题目ID </td>
		<td style="width:200px;">标题 </td>
	</tr>
	<tr>
		<td>A     </td>
		<td>  度度熊就是要第一个出场</td>
	</tr>
	<tr>
		<td>B     </td>
		<td>  小小度刷礼品</td>
	</tr>
	<tr>
		<td>C     </td>
		<td>  集合的交与并</td>
	</tr>
	<tr>
		<td>D     </td>
		<td>  轮子上的度度熊</td>
	</tr>
</table>
<p></p>
<p>这场做了B和D吧, B就是很土的算1到N里面有多少个以x结尾的数, D的话我暴力了一下，大数据会超时，不过来不及想优化了, 感觉没有优化写起来就像很无聊的DP。 另外A其实是可做的，bfs一下应该就可以了, 跟印象中某ZOJ月赛一题有像，也跟今年的WF的镜面反射的题目有点相似(题型)。 感觉运气好可以晋级吧，毕竟只做了1题多一点点而已。</p>
<ul>
	<li><strong>ipsc 2012</strong><br />
与毛哥一起搞了今年的ipsc, 用的是我们当年组队的名字 <code>ACOrz</code> , 可惜daxia没来一起做。稍微迟到了半小时，毛哥已经把A过了，然后看了C, F, I了。C我尝试了两三次，无果，后面先放弃了。放弃C之后就很顺了，跟毛哥一起砍了一些大众题目。依次是
	<ul>
		<li>G<br />
算有向图最大长度的链。由于图挺特殊的，只有一个出度，故也挺好算。</li>
		<li>I<br />
<a href="http://www.md5decrypt.org/">md5 decrypt</a> 挺好用的，直接将大小数据都过了= =国内的网站就不行，还要收费- -</li>
		<li>F<br />
毛哥暴力了小数据，然后我们在只有两个硬币的情况下做简单演算, 得到 <code>p1*(1-p2)+p2*(1-p1)=1/2</code>  这个式子，直接解出 <code>p1 = 1/2 or p2 = 1/2</code>  , 于是也很容易了。</li>
		<li>C1<br />
C1 后面我又试了下记忆化搜索，于是就过了= =, 一开始dp比较随意了，改成记忆化暴力所有可能于是过了。猜测大数据也是类似搞法，不过状态可能稍微多了，未作深究。</li>
		<li>B<br />
B毛哥猜得很欢乐， B1还好，B2我们真是非常惊险，猜到第30次才得到答案(最多猜测30次)，毛哥还用啥迭代法来逼近来着。<br />
<img src="/images/ipsc_2012-2.png"><br />
最终ipsc排名一百多名，算是本周最欢乐的比赛了，当然还有很多没有切出来, 回头可以再看看。<br />
<img src="/images/ipsc_2012-1.png"></li>
	</ul></li>
</ul>
<ul>
	<li><span class="caps">TCO</span> 2012 R2c<br />
ipsc 做到了晚上11点结束，12点就是 <code>TCO R2c</code>了，能不能拿衣服就看这场了。悲剧的是比赛前20分钟家里断网了，折腾了好些,搞好的时候已经12点20分了，顾不上就奔去了。300分是一个有点代码量的枚举，写到了144分。。500打开只有半小时了，看了下，这不就是土土的树状数组吗！马上搞啊搞，在最后10分钟的时候样例一直过不了，还有一个即simple的样例，没来得及看明白 比赛结束了。后面再看了下，发现题目看错了= = 顺序有点小变化，当然做法还是树状数组。感觉构造还是挺巧妙的，多增加了啥，该扣除啥。另外本次的900pt貌似也可做，没来得及看，某些人直接搞900晋级了，真给力。</li>
</ul>
<ul>
	<li>Astar 2012 R1b<br />
由于2号搞到比较晚，起床的时候已经是10:30了，外加还得洗碗= = 题目现在看不到了，仍然是4道题。最终做了B, C。B是二分加并查集，挺简单的。C 简单yy了一个贪心，感觉想简单了。A是算n个数中选若干数异或值的最大和次大，没想明白，  <a href="http://hi.baidu.com/pojoflcc/blog/item/c85dccdbb967c0c1b7fd4805.html">别人说是&#8217;搞基&#8217;</a> 。 D没有想法。 这场要晋级的话也比较悬，重在参与~</li>
</ul>
<p>总之，整个周末还是挺紧凑以及有趣的(还出去骑了两次车)，每次比赛后都留下一些未解之谜，现在不能像以往一一攻克并提高战斗力了，不过真想把不会的继续搞懂！</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/21/deal-with-special-characters-in-hive-query-result/">Deal With Special Characters in Hive Query Result</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-21T01:21:00+08:00" pubdate data-updated="true">May 21<span>st</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="date">2012-06-02</p>
<p>知识，想法是需要整理的， 不然容易遗忘, 又过了好久没有更新, 怨念= -<br />
这段时间搞了一点hive之类的东西，遇到一些问题，后续也许还会整理一点出来。<br />
最近遇到的关于hive的问题是:</p>
<blockquote>
<p>将hive查询结果从临时文件导入mysql的时候, 由于查询结果中有特殊字符(比如反斜杠, 制表符等), 导致数据导入mysql时解析出错。</p>
</blockquote>
<p>这里得先说明一下mysql导入导出的默认行为。 <a href="http://stackoverflow.com/questions/7287658/mysql-escape-backslash">mysql命令行输出默认会做转义</a> 并且在 <a href="http://dev.mysql.com/doc/refman/5.0/en/server-sql-mode.html#sqlmode_no_backslash_escapes">导入的时候默认会将反斜杠转义</a> , 我们一般不会感觉到这一步。当相同问题发生在hive的查询结果时,有些时候字段末尾或行末尾的 <code>\</code> 会将间隔符 <code>\t</code> 或换行符 <code>\n</code> 转义, 导致导入出错。 如果关闭mysql导入时默认转义的话, 那么字段中包含的间隔符 <code>\t</code> 会导致列数变多，同样出现问题。</p>
<p>十分讨厌hive查询结果中的特殊字符, 究其原因主要是 <a href="https://issues.apache.org/jira/browse/HIVE-692">hive查询结果目前无法对特殊字符进行转义</a> , 另外比较头疼的是 <code>hive cli</code> 或者 <code>hiveserver</code> 的查询结果中, 默认的字段分隔符都是 <code>\t</code> 且不方便变更。 在解析日志的过程中, 字段中难免包括 <code>\t</code>,  <code>\</code> 这类特殊字符。此问题还得仔细对待, 在网上搜了下，大概有几种方法, 未找着较优雅的方案。</p>
<h3>绕过转义问题</h3>
<p>一种做法是我们绕过此问题。如果我们不对查询结果进行转义，那么我们就只能让mysql不对导入数据进行转义了( <code>no_backslash_escapes</code> ), 这里需要我们对查询结果给定一个特殊的分隔符，比如 <code>0x01</code> 。</p>
<ul>
	<li><strong><span class="caps">CTAS</span></strong><br />
具体内容即</li>
</ul>
<blockquote>
<p>When you are doing output to the console \T is your only option. The<br />
best way to handle this is create another table with the delimiters<br />
you wish and then select into that table. You can do this with <span class="caps">CTAS</span>.</p>
</blockquote>
<p>比如</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>CTAS </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>create table xzy 
</span><span class='line'>row format delimited
</span><span class='line'>fields terminated by '\001'
</span><span class='line'>as select age, dt  from ibtest limit 1;</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>这里可以指定任意的分隔符，但这边文件在 <code>/user/hive/warehouse/xzy</code> 中，我们还得将其合并输出到临时文件中。</p>
<ul>
	<li><span class="caps">INSERT</span> <span class="caps">OVERWRITE</span> <span class="caps">LOCAL</span> <span class="caps">DIRECTORY</span></li>
</ul>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>local directory </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INSERT OVERWRITE LOCAL DIRECTORY '/mydir'
</span><span class='line'>SELECT XXX</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>直接写到外部文件夹, 此时分隔符为 <code>0x01</code> 。</p>
<ul>
	<li><strong>concat_ws</strong><br />
这个算是一个比较取巧的方法吧，xyc介绍的:<br />
将查询结果先转成string, 然后 <strong>concat</strong> 起来，并指定分隔符。这样由于最终只有一列，所以不会 加上系统默认的分隔符了。</li>
</ul>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>concat_ws </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>select concat_ws('\001', cast(userid as string), cast(cityid as string), regdate) from hiveuser limit 10;</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<h3>勉强进行转义</h3>
<p>另外一种做法是勉强在hql中进行转义, 比如将 <code>\</code> 替换成 <code>\\</code> , 将制表符替换成 <code>\</code> 和 <code>t</code> :</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>regexp_replace </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>regexp_replace(regexp_replace(column, '\\\\', '\\\\\\\\'), '\t', '\\\\t')</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>这里得在可能出现特殊字符的地方做上述修改, 为防止写得繁琐，可以考虑封成 <code>udf</code> 。</p>
<h3>总结</h3>
<p>总而言之，目前并没想到较好的处理方法。反过来想，类似制表符的特殊字符在日志中是否有意义，如果没有的话，可否去掉?  这样一来就愉快多了，但是 <strong>破坏原始日志</strong> ，感觉也不是很好。</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/24/how-to-build-a-dynamic-sql-in-an-elegant-way/">How to Build a Dynamic SQL in an Elegant Way</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-24T11:27:00+08:00" pubdate data-updated="true">Mar 24<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="date">2012-04-04</p>
<p>换上octopress, 写blog还是不勤快, 目前装在虚拟机当中，怎么勤快:(。</p>
<p>不岔开话题，这次讨论的是如何 <strong>动态地生成一条查询SQL</strong> 。起因是一个统计报表要新增加一些筛选条件， 而这些筛选条件并非简单加一个where条件，有时还要涉及到联表(join)以及聚合条件的改变。原先我的做法是 设几个变量，诸如where, groupby, joins等，然后再将这几个变量合起来，这之中得考虑逗号，是否需要插入&#8217;and&#8217;等， 简单来说还行，但如果多个地方都需要用到，那么稍微麻烦了，而且代码重复较多, 所以我想找找有没有动态生成查询SQL的更方便的方法。</p>
<p>看到 <a href="http://patrickallaert.blogspot.com/2007/09/building-dynamic-sql-queries-elegant.html">一篇blog</a> , 大概讲的就是平常的一些小技巧吧, 比如使用implode来拼where条件。</p>
<p>后来在stackoverflow看到 <a href="http://stackoverflow.com/questions/2258438/how-do-i-build-a-dynamic-sql-query">一个帖子</a> , 这个问题跟我面对的问题基本一致，帖子的第一个解答即是我最终采取的方案。即是写一些函数来记录主要的内容(select内容，join表与条件, where条件, groupby条件等), 然后按确定的方式来拼出最终的查询语句。</p>
<p>后面看到一个 <a href="http://openhms.sourceforge.net/sqlbuilder/example.html">squlbuilder</a> ，看上去有点重，有很多功能目前都还不需要用到。</p>
<p>最后看到github上的一个 <a href="https://github.com/c9s/SQLBuilder">SQLBuilder</a> ，感觉实现得还不错，当然也有很多我不太需求的功能，故在其基础上删减了一下，快速实现了，放到 <a href="https://github.com/code6/query-builder">github</a> 上了。</p>
<p>一个简单的demo:</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>demo 1 </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$sqlbuilder = new QueryBuilder();
</span><span class='line'> $sqlbuilder->table('fact.`order`', 'f')
</span><span class='line'>          ->select(array(
</span><span class='line'>                'city',
</span><span class='line'>               'quantity' => 'sum(quantity)',
</span><span class='line'>               'averageprice' => 'ifnull(sum(revenue) / sum(quantity), 0)'))
</span><span class='line'>          ->join('dim.date', 'd', '', 'f.date = d.date')
</span><span class='line'>          ->where('d.date between ? and ?', 'ss', array($begin_date, $end_date))
</span><span class='line'>          ->groupby('d.month_num_overall')
</span><span class='line'>          ->orderby('d.month_num_overall desc')
</span><span class='line'>          ->limit(3)
</span><span class='line'>          ->offset(3);
</span><span class='line'>
</span><span class='line'>echo $sqlbuilder->build();</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>输出结果格式化如下:</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>demo 1 output </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SELECT city,
</span><span class='line'>       sum(quantity) AS quantity,
</span><span class='line'>       ifnull(sum(revenue) / sum(quantity), 0) AS averageprice
</span><span class='line'>FROM fact.`order` f
</span><span class='line'>JOIN dim.date d ON f.date = d.date
</span><span class='line'>WHERE d.date BETWEEN ? AND ?
</span><span class='line'>GROUP BY d.month_num_overall
</span><span class='line'>ORDER BY d.month_num_overall DESC,d.month_num_overall ASC 
</span><span class='line'>LIMIT 3, 3</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>其中 <code>getBindParams</code> 函数返回一个数组, 包含绑定的变量的类型以及具体的变量, 比如 <code>array('ii', 1, 2)</code> , 而 <code>getReturnParams</code> 函数则返回查询结果列名数组。</p>
<p>目前还简单增加了 <strong>子查询</strong> 的支持。</p>
<p>一个查询 <a href="http://en.wikipedia.org/wiki/Gini_coefficient">gini系数</a> 的demo如下:</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>gini demo </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$sub1 = new QueryBuilder();
</span><span class='line'>$sub1->table('fact.`order`', 'f')
</span><span class='line'>  ->where('d.date between ? and ?', 'ss', array($begin_date, $end_date))
</span><span class='line'>  ->where ('coupontype != 4')
</span><span class='line'>  ->orderby('focus', 'f.revenue');
</span><span class='line'>
</span><span class='line'>$sub0 = new QueryBuilder();
</span><span class='line'>$sub0->table(" (select @cs := 0) ", 'cs_idx')
</span><span class='line'>  ->join(" (select @focus:='') ", "s_idx")
</span><span class='line'>  ->join($sub1, 'raw')
</span><span class='line'>  ->select(array('accumulate_revenue' => '@cs := CASE WHEN @focus != raw.focus THEN raw.revenue ELSE @cs + raw.revenue END',
</span><span class='line'>                'focus' => '@focus := raw.focus'));
</span><span class='line'>
</span><span class='line'>$gini  = new QueryBuilder();
</span><span class='line'>$gini->table($sub0, 'base')
</span><span class='line'>  ->select(array(
</span><span class='line'>        'focus',
</span><span class='line'>       'g' => 'truncate(1 - 1.0 / count(*) * (2 * sum(base.accumulate_revenue) / max(base.accumulate_revenue) -1), 2)'))
</span><span class='line'>  ->groupby('base.focus');
</span><span class='line'>
</span><span class='line'>echo $gini->build();</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>输出如下:</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>gini demo output </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SELECT focus,
</span><span class='line'>       truncate(1 - 1.0 / count(*) * (2 * sum(base.accumulate_revenue) / max(base.accumulate_revenue) -1), 2) AS g
</span><span class='line'>FROM
</span><span class='line'>  (SELECT @cs := CASE
</span><span class='line'>                     WHEN @focus != raw.focus THEN raw.revenue
</span><span class='line'>                     ELSE @cs + raw.revenue
</span><span class='line'>                 END AS accumulate_revenue, @focus := raw. focus AS focus
</span><span class='line'>   FROM
</span><span class='line'>     (SELECT @cs := 0) cs_idx
</span><span class='line'>   JOIN
</span><span class='line'>     (SELECT @focus:='') s_idx
</span><span class='line'>   JOIN
</span><span class='line'>     ( SELECT f.FOCUS AS focus,
</span><span class='line'>          f.revenue
</span><span class='line'>      FROM fact.`order` f
</span><span class='line'>      WHERE d.date be tween ?
</span><span class='line'>        AND ?
</span><span class='line'>        AND coupontype != 4
</span><span class='line'>      ORDER BY focus,
</span><span class='line'>               f.revenue) raw) base
</span><span class='line'>GROUP BY base.focus</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>代码测试方面, 后面发现参考代码是使用 <a href="http://www.phpunit.de/manual/current/en/installation.html">phpunit</a> 来进行单元测试的，简单地使用一下，还是挺好用的:)</p>
<p>目前还算能满足需求，当然对于预处理语句的变量处理还可以改进，收集需求再改进吧。</p></div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/algorithm/'>algorithm (1)</a></li>
<li class='category'><a href='/blog/categories/blog/'>blog (1)</a></li>
<li class='category'><a href='/blog/categories/contest/'>contest (1)</a></li>
<li class='category'><a href='/blog/categories/hive/'>hive (3)</a></li>
<li class='category'><a href='/blog/categories/programming/'>programming (2)</a></li>
<li class='category'><a href='/blog/categories/sql/'>sql (1)</a></li>
<li class='category'><a href='/blog/categories/thoughts/'>thoughts (1)</a></li>

  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/04/15/keep-updating-your-cv/">keep updating your cv</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/04/query-evolution/">query evolution</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/09/create-a-python-package/">create a python package</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/02/open-hive/">open hive</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/19/hive-compile-and-apply-patch/">hive compile and apply patch</a>
      </li>
    
  </ul>
</section>
<section class="friend-link">
  <h1>Links</h1>
  <ul>
    <li>
      <a href="http://panweizeng.com/">增哥</a>
    </li>
    <li>
      <a href="http://http://shangchun.net/">春哥</a>
    </li>
    <li>
      <a href="http://chenzongzhi.info/">志哥</a>
    </li>
    <li>
      <a href="http://davidzai.blog.163.com/blog">3xian</a>
    </li>
    <li>
      <a href="http://heliang.me/blog">Roba</a>
    </li>
  </ul>
  <br/>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/code6">@code6</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'code6',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("wzc1989", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/wzc1989" class="twitter-follow-button" data-show-count="false">Follow @wzc1989</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/104473212256457667839?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Code6 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'code6';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
